{% extends "layouts/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5" id="employee-list-container">
    <h2 class="text-center mb-4">{{ title }}</h2>

    <!-- Форма фильтрации -->
    <form method="get" class="mb-4" id="filter-form">
        <div class="form-group">
            <label for="id_first_name">Имя:</label>
            {{ filter.form.first_name }}
        </div>
        <div class="form-group">
            <label for="id_last_name">Фамилия:</label>
            {{ filter.form.last_name }}
        </div>
        <div class="form-group">
            <label for="id_position">Должность:</label>
            {{ filter.form.position }}
        </div>
        <div class="form-group">
            <label for="id_hire_date_after">Hire date (from):</label>
            {{ filter.form.hire_date.after }}
        </div>
        <div class="form-group">
            <label for="id_hire_date_before">Hire date (to):</label>
            {{ filter.form.hire_date.before }}
        </div>
        <div class="form-group">
            <label for="id_salary">Salary:</label>
            {{ filter.form.salary }}
        </div>
        <button type="submit" class="btn btn-primary">Фильтровать</button>
    </form>

    <!-- Таблица сотрудников -->
    <div id="employee-table">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>№</th>
                    <th class="sortable"><a href="#" data-ordering="first_name">Имя</a></th>
                    <th class="sortable"><a href="#" data-ordering="last_name">Фамилия</a></th>
                    <th class="sortable"><a href="#" data-ordering="position">Должность</a></th>
                    <th class="sortable"><a href="#" data-ordering="hire_date">Дата приёма</a></th>
                    <th class="sortable"><a href="#" data-ordering="salary">Зарплата</a></th>
                    <th class="sortable"><a href="#" data-ordering="manager__last_name">Менеджер</a></th>
                </tr>
            </thead>
            <tbody>
                {% for employee in employees %}
                <tr>
                    <td>{{ employee.id }}</td>
                    <td>{{ employee.first_name }}</td>
                    <td>{{ employee.last_name }}</td>
                    <td>{{ employee.position }}</td>
                    <td>{{ employee.hire_date }}</td>
                    <td>{{ employee.salary }}</td>
                    <td>{% if employee.manager %}{{ employee.manager.first_name }} {{ employee.manager.last_name }}{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% include 'layouts/pagination.html' %}
</div>

<!-- AJAX пагинация и фильтрация -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // AJAX пагинация
        $(document).on('click', '#pagination a.page-link', function(e) {
            e.preventDefault();
            let page_url = $(this).attr('href');
            loadTableData(page_url);
        });

        // AJAX фильтрация
        $('#filter-form').submit(function(e) {
            e.preventDefault();
            let form_data = $(this).serialize();
            loadTableData(`?${form_data}`);
        });

        function loadTableData(url) {
            $.ajax({
                url: url,
                type: 'GET',
                success: function(data) {
                    $('#employee-list-container').html($(data).find('#employee-list-container').html());
                }
            });
        }
    });
</script>

{% endblock %}