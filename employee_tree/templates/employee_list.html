{% extends "layouts/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">{{ title }}</h2>

    <!-- Форма фильтрации -->
    <form method="get" class="mb-4">
        <div class="form-group">
            <label for="id_first_name">Имя:</label>
            {{ filter.form.first_name }}
        </div>
        <div class="form-group">
            <label for="id_last_name">Фамилия:</label>
            {{ filter.form.last_name }}
        </div>
        <div class="form-group">
            <label for="id_position">Должность:</label>
            {{ filter.form.position }}
        </div>
        <div class="form-group">
            <label for="id_hire_date_after">Hire date (from):</label>
            {{ filter.form.hire_date.after }}
        </div>
        <div class="form-group">
            <label for="id_hire_date_before">Hire date (to):</label>
            {{ filter.form.hire_date.before }}
        </div>
        <div class="form-group">
            <label for="id_salary">Salary:</label>
            {{ filter.form.salary }}
        </div>
        <button type="submit" class="btn btn-primary">Фильтровать</button>
    </form>

    <!-- Таблица сотрудников -->
    <table class="table table-striped" id="employee-table">
        <thead>
            <tr>
                <th>№</th>
                <th class="sortable"><a href="#" data-ordering="first_name">Имя</a></th>
                <th class="sortable"><a href="#" data-ordering="last_name">Фамилия</a></th>
                <th class="sortable"><a href="#" data-ordering="position">Должность</a></th>
                <th class="sortable"><a href="#" data-ordering="hire_date">Дата приёма</a></th>
                <th class="sortable"><a href="#" data-ordering="salary">Зарплата</a></th>
                <th class="sortable"><a href="#" data-ordering="manager__last_name">Менеджер</a></th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ employee.first_name }}</td>
                <td>{{ employee.last_name }}</td>
                <td>{{ employee.position }}</td>
                <td>{{ employee.hire_date }}</td>
                <td>{{ employee.salary }}</td>
                <td>{% if employee.manager %}{{ employee.manager.first_name }} {{ employee.manager.last_name }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Пагинация -->
    <nav aria-label="Постраничная навигация">
        <ul class="pagination justify-content-center mt-4">
            {% if employees.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ employees.previous_page_number }}&{{ request.GET.urlencode|default:'' }}">Назад</a>
                </li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Страница {{ employees.number }} из {{ employees.paginator.num_pages }}</span></li>

            {% if employees.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ employees.next_page_number }}&{{ request.GET.urlencode|default:'' }}">Вперед</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- AJAX сортировка -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.sortable a').click(function(e) {
            e.preventDefault();
            let currentOrdering = $(this).data('ordering');
            let newOrdering = currentOrdering.startsWith('-') ? currentOrdering.substring(1) : '-' + currentOrdering;
            $(this).data('ordering', newOrdering);
            $.ajax({
                url: window.location.pathname,
                data: {
                    ordering: newOrdering,
                    filter: $('form').serialize(),
                },
                success: function(data) {
                    $('#employee-table tbody').html($(data.html).find('#employee-table tbody').html());
                },
                error: function() {
                    alert('Ошибка загрузки данных');
                }
            });
        });
    });
</script>

{% endblock %}